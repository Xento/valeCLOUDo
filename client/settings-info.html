<ons-page id="settings-info-page">
	<ons-toolbar>
		<div class="left">
			<ons-back-button data-i18n="settings.title" data-i18n-target=".back-button__label">Settings</ons-back-button>
		</div>
		<div class="center" data-i18n="settings.infoTitle">Info</div>
		<div class="right">
		</div>
	</ons-toolbar>
	<ons-progress-bar id="loading-bar-settings-info" value="0" indeterminate="indeterminate"></ons-progress-bar>

	<ons-list-title style="margin-top:5px;" data-i18n="settings.info.system">System</ons-list-title>
	<ons-list>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.firmwareVersion">
				Firmware version:
			</div>
			<div class="right" id="info_fw_version" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.firmwareBuild">
				Firmware build:
			</div>
			<div class="right" id="info_fw_build" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.firmwareUpdate">
				Firmware update:
			</div>
			<div class="right" id="info_fw_update">
				<a id="sendUpdateRequestButton" onclick="sendUpdateRequest();" data-i18n="settings.info.firmwareUpdateLink">[send request]</a>
				<a id="sendUpdateRequestExp" onclick="sendUpdateRequestExp(this);"><i class="far fa-question-circle"></i></a>
			</div>
		</ons-list-item>
	</ons-list>
	<ons-list-title style="margin-top:5px;" data-i18n="settings.info.currentToken">Current Token</ons-list-title>
	<ons-list>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.token">
				Token:
			</div>
			<div class="right">
				<span id="current_token_label" style="text-align:right;user-select:text;-moz-user-select:text;-ms-user-select:text;-webkit-user-select:text;" data-i18n="settings.loading">
					loading...
				</span>
			</div>
		</ons-list-item>
	</ons-list>
	<ons-list-title style="margin-top:5px;" data-i18n="settings.info.appLocale">App Locale</ons-list-title>
	<ons-list>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.appLocaleName">
				Name:
			</div>
			<div class="right" id="app_locale_name" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.appLocaleBom">
				Bom:
			</div>
			<div class="right" id="app_locale_bom" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.appLocaleLocation">
				Location:
			</div>
			<div class="right" id="app_locale_location" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.appLocaleLanguage">
				Language:
			</div>
			<div class="right" id="app_locale_language" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.appLocaleTimezone">
				Timezone:
			</div>
			<div class="right" id="app_locale_timezone" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.appLocaleLogserver">
				Logserver:
			</div>
			<div class="right" id="app_locale_logserver" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
	</ons-list>
	<ons-list-title style="margin-top:5px;" data-i18n="settings.info.valetudo">Valetudo RE</ons-list-title>
	<ons-list>
		<ons-list-item>
			<div class="left">
				NODE.JS
			</div>
			<div class="right" id="info_nodejs_version" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.currentValetudoVersion">
				Current version:
			</div>
			<div class="right" id="info_valetudo_version" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
		<ons-list-item>
			<div class="left" data-i18n="settings.info.newValetudoVersion">
				Latest version:
			</div>
			<div class="right" id="info_new_valetudo_version">
				<ons-button modifier="large" class="button-margin" onclick="checkNewValetudoVersion();" data-i18n="settings.info.checkVersion">Check</ons-button>
			</div>
		</ons-list-item>
		<ons-list-item id="info_valetudo_update_url_list" style="display: none;">
			<div class="left" data-i18n="settings.info.newVersionURL">
				New version URL:
			</div>
			<div class="right" id="info_valetudo_update_url" data-i18n="settings.loading">
				loading...
			</div>
		</ons-list-item>
	</ons-list>
	<ons-list-title style="margin-top:5px;">
		<span data-i18n="settings.info.valetudoLog">Valetudo System Log</span> <ons-toolbar-button class="system-log-reload" onclick="reloadValetudoLog();"><ons-icon icon="fa-refresh"></ons-icon></ons-toolbar-button>
	</ons-list-title>
	<ons-list>
		<ons-list-item>
			<div class="system-log-field"><textarea id="system_log_data" class="system-log-textarea" readonly></textarea></div>
		</ons-list-item>
	</ons-list>
	<ons-popover direction="left" id="exp_fw_update" cancelable>
		<div style="padding: 10px; text-align: center;" data-i18n="settings.info.firmwareUpdateWarning">
			This will try to update device's firmware using manually entered URL to pkg file and its MD5 hash value. Note that URL should point to public IP address and have no redirects.
		</div>
	</ons-popover>
	<script>
		var loadingBarSettingsInfo = document.getElementById('loading-bar-settings-info');

		document.querySelector("#settings-info-page ons-back-button").onClick = () => fn.popPage(); // case matters!

		document.getElementById('system_log_data').addEventListener('mouseover',siDisableSwipe,false);
		document.getElementById('system_log_data').addEventListener('mouseout',siEnableSwipe,false);
		function siDisableSwipe() {
			document.getElementById('sidemenu').removeAttribute("swipeable");
			document.getElementById('appTabbar').removeAttribute("swipeable");
			document.getElementById('appNavigator').removeAttribute("swipeable");
		}
		function siEnableSwipe() {
			document.getElementById('sidemenu').setAttribute("swipeable","swipeable");
			document.getElementById('appTabbar').setAttribute("swipeable","swipeable");
			document.getElementById('appNavigator').setAttribute("swipeable","swipeable");
		}

		ons.getScriptPage().onShow = function() {
			loadingBarSettingsInfo.setAttribute("indeterminate", "indeterminate");
			const updateSystemInfo = fn.prequest("api/get_fw_version")
			.then((res) => {
				document.getElementById('info_fw_version').innerText = res.version;
				document.getElementById('info_fw_build').innerText = res.build;
				document.getElementById('info_nodejs_version').innerText = res.nodejs;
				document.getElementById('info_valetudo_version').innerText = res.valetudo;
			}, (err) => fn.notificationToastError(err));
			const updateAppLocaleInfo = fn.prequest("api/get_app_locale")
			.then(res => {
				var appLocale = res[0];
				document.getElementById('app_locale_name').innerText = appLocale.name;
				document.getElementById('app_locale_bom').innerText = appLocale.bom;
				document.getElementById('app_locale_location').innerText = appLocale.location;
				document.getElementById('app_locale_language').innerText = appLocale.language;
				document.getElementById('app_locale_timezone').innerText = appLocale.timezone;
				document.getElementById('app_locale_logserver').innerText = appLocale.logserver;
			}, err => fn.notificationToastError(err));
			const updateCurrentTokenInfo = fn.prequest("api/token")
			.then(res => {
				document.getElementById('current_token_label').innerText = res.token;
			}, err => fn.notificationToastError(err));
			Promise.all([updateSystemInfo, updateAppLocaleInfo, updateCurrentTokenInfo, reloadValetudoLog(true)]).finally(() => loadingBarSettingsInfo.removeAttribute("indeterminate"));
		};

		function reloadValetudoLog(getPromise) {
			const getLog = function() {
				return fn.prequest("api/valetudo_log").then(res => {
					document.getElementById('system_log_data').value = res.split('\n').reverse().join('\n').trim();
				}, err => fn.notificationToastError(err));
			};
			if (getPromise) return getLog();
			loadingBarSettingsInfo.setAttribute("indeterminate", "indeterminate");
			getLog().then(() => loadingBarSettingsInfo.removeAttribute("indeterminate"));
			return true;
		}

		function sendUpdateRequestExp(anchor) {
			document.getElementById('exp_fw_update').show(anchor);
		}

		function sendUpdateRequest() {
			let url, md5;
			ons.notification.prompt(i18next.t('settings.info.firmwareUpdateEnterURL',"Please enter URL to firmware pkg file:"),{title: i18next.t('common.prompt',"Prompt"), cancelable: true, buttonLabels: [i18next.t('common.cancel',"Cancel"), i18next.t('common.ok',"OK")]})
			.then(res => {
				if (!res) return Promise.reject("cancel");
				url = res;
				return ons.notification.prompt(i18next.t('settings.info.firmwareUpdateEnterMD5',"Please enter MD5 hash of the file you just specified:"),{title: i18next.t('common.prompt',"Prompt"), cancelable: true, buttonLabels: [i18next.t('common.cancel',"Cancel"), i18next.t('settings.info.firmwareUpdateSend',"Send!")]});
			})
			.then(res => {
				if (!res) return Promise.reject("cancel");
				md5 = res;
				loadingBarSettingsInfo.setAttribute("indeterminate", "indeterminate");
				return fn.prequestWithPayload("api/send_update_request", JSON.stringify({url: url, md5: md5}), "PUT");
			})
			.then(res => {
				document.getElementById('info_fw_update').innerText = 'status: waiting...';
				setTimeout(getUpdateRequestStatus,3e3);
			})
			.then(res => fn.notificationToastOK(i18next.t('settings.info.firmwareUpdateSentOK',"Update request should be sent! Wait for LED indication of update process."),6e3))
			.catch(err => {
				if (err !== "cancel") fn.notificationToastError(err);
			})
			.finally(() => loadingBarSettingsInfo.removeAttribute("indeterminate"));
		}

		function getUpdateRequestStatus() {
			let stop = false;
			loadingBarSettingsInfo.setAttribute("indeterminate", "indeterminate");
			fn.prequest("api/get_ota_state")
			.then(res => {
				let stateField = document.getElementById('info_fw_update');
				if (stateField) {
					stateField.innerText = 'status: ' + res;
				}
				if (["idle","failed"].includes(res) || !stateField) {
					stop = true;
				}
			})
			.catch(err => fn.notificationToastError(err))
			.finally(() => {
				loadingBarSettingsInfo.removeAttribute("indeterminate");
				if (!stop) { setTimeout(getUpdateRequestStatus,3e3); }
			});
		}

		function checkNewValetudoVersion() {
			loadingBarSettingsInfo.setAttribute("indeterminate", "indeterminate");
			fn.prequest("https://api.github.com/repos/rand256/valetudo/releases")
			.then((res) => {
				try {
					var info_valetudo_new_release = res[0];
					document.getElementById('info_new_valetudo_version').textContent = 'v' + info_valetudo_new_release.tag_name;
					document.getElementById('info_valetudo_update_url').innerHTML = '<a href="'+info_valetudo_new_release.html_url+'">'+info_valetudo_new_release.html_url+'</a>';
					if( document.getElementById('info_valetudo_version').textContent != 'v' + info_valetudo_new_release.tag_name)
					{
							document.getElementById('info_valetudo_update_url_list').style.display = ""; //make entry visible if newer version is available
					}
				} catch (e) {
					ons.notification.toast(e, { buttonLabel: 'Dismiss', timeout: 1500 });
				}
			}, (err) => fn.notificationToastError(err))
			.finally(() => loadingBarSettingsInfo.removeAttribute("indeterminate"));
		}
		ons.getScriptPage().onInit = function() {
			fn.localize('#settings-info-page');
		};
	</script>
	<style>
		#sendUpdateRequestButton {
			font-size: 0.8em;
			text-decoration: underline;
			cursor: pointer;
		}
		#sendUpdateRequestExp {
			padding-left: 0.5em;
		}
		.system-log-reload {
			font-size: small;
			line-height: 1em;
		}
		.system-log-field {
			width: 95%;
			margin: 0.5em auto;
		}
		.system-log-textarea {
			height: 15em;
			width: 100%;
			white-space: pre;
		}
	</style>
</ons-page>